name: Wait for e2e test status

on:
    workflow_call:
        inputs:
            environment:
                type: string
            wait-timeout:
                type: number
                default: 15
            test-type:
                type: string
                default: cypress
            branch:
                type: string
            repo:
                type: string

jobs:
    wait-for-e2e-test-status:
        runs-on: ubuntu-latest

        permissions:
            id-token: write # This is required for requesting the JWT
            contents: read # This is required for actions/checkout

        steps:
            - name: Login as OIDC for metrics account
              uses: aws-actions/configure-aws-credentials@v1.7.0
              with:
                  role-to-assume: arn:aws:iam::404548253908:role/monitoring-githubactionsrole74C434B1-zIAFzeH9CXA5
                  role-session-name: GitHub_to_AWS_via_Federated_Metrics_OIDC
                  aws-region: eu-central-1

            - name: Set test status payload and message
              run: |
                  if [[ -n "${{ inputs.branch }}" && -n "${{ inputs.repo }}" ]]; then
                    echo "TEST_STATUS_PAYLOAD=$(jq -n -c --arg type 'test_status' --arg branch_name '${{ inputs.branch }}' --arg repo '${{ inputs.repo }}' --arg environment '${{ inputs.environment || '' }}' '{type: $type, branch_name: $branch_name, repo: $repo, environment: $environment}')" >> $GITHUB_ENV
                    echo "WAITING_MESSAGE=Waiting for ${{ inputs.test-type }} tests results for branch ${{ inputs.branch }} in repo ${{ inputs.repo }}..." >> $GITHUB_ENV
                  else
                    echo "TEST_STATUS_PAYLOAD=$(jq -n -c --arg type 'test_status' --arg sha '${{ github.sha }}' --arg test_type '${{ inputs.test-type }}' --arg environment '${{ inputs.environment || '' }}' '{type: $type, sha: $sha, test_type: $test_type, environment: $environment}')" >> $GITHUB_ENV
                    echo "WAITING_MESSAGE=Waiting for ${{ inputs.test-type }} tests results for ${{ github.sha }}..." >> $GITHUB_ENV
                  fi

            - name: Invoke the lambda and wait until it does not return pending
              timeout-minutes: ${{ inputs.wait-timeout }}
              run: |
                  until [[ $(aws lambda invoke --function-name cdkmetrics --cli-binary-format raw-in-base64-out --payload "$TEST_STATUS_PAYLOAD" /dev/stdout 2>/dev/null --no-cli-pager | jq -r '.status | select( . != null )') != "pending" ]]; do
                    echo "$WAITING_MESSAGE"
                    sleep 5
                  done

            - name: Check the status of the ${{ inputs.test-type }} tests and fail the workflow if tests failed
              run: |
                  status=$(aws lambda invoke --function-name cdkmetrics --cli-binary-format raw-in-base64-out --payload "$TEST_STATUS_PAYLOAD" /dev/stdout 2>/dev/null --no-cli-pager | jq -r '.status | select( . != null )')
                  echo "The status of the ${{ inputs.test-type }} tests is $status"

                  # post the link to the test run to the summary
                  last_run_id=$(aws lambda invoke --function-name cdkmetrics --cli-binary-format raw-in-base64-out --payload '{"type": "get_last_test_run_id", "sha": "${{ github.sha }}"}' /dev/stdout 2>/dev/null --no-cli-pager | jq -r '.last_run_id | select( . != null )')
                  echo "[E2E test run](https://github.com/doctariDev/planerio-e2e-tests/actions/runs/$last_run_id)" >> $GITHUB_STEP_SUMMARY

                  if [[ $status == "failed" ]]; then
                    exit 1
                  fi

            - name: Continue with the workflow
              run: echo "The ${{ inputs.test-type }} tests passed"
